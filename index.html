<!doctype html>

<html>
    <head>
        <script src="src/notate.js"></script>

        <script type="text/javascript">

            /** The horizontal page margins, in pixels */
            var MARGIN_HORIZ = 30;
            /** The vertical page margins, in pixels */
            var MARGIN_VERT = 50;
            /** Height of a line of the staff, in pixels */
            var STAFF_LINE_HEIGHT = 1;
            /** Number of pixels of blank space between staff lines, in pixels */
            var STAFF_LINE_SPACING = 8;
            /** Number of pixels between staves, in pixels */
            var STAFF_SPACING = 50;
            /** Number of lines in a staff */
            var STAFF_LINE_COUNT = 5;
            /** The radius of the note head at its narrowest point, in pixels */
            var NOTE_HEAD_RADIUS_MIN = 4;
            /** The radius of the note head at its widest point, in pixels */
            var NOTE_HEAD_RADIUS_MAX = 6;
            /** The rotation of the note head, in radians */
            var NOTE_HEAD_ROTATION = -.4;
            /** The width of the note stem, in pixels */
            var NOTE_STEM_WIDTH = 1;
            /** The height of the note stem, in pixels */
            var NOTE_STEM_HEIGHT = 30;

            function dimensions(canvas) {
                var w = canvas.width,
                    h = canvas.height;

                if (window.devicePixelRatio) {
                    var ratio = window.devicePixelRatio;
                    w /= ratio;
                    h /= ratio;
                }

                return [w, h];
            }

            function renderNoteHead(canvas, ctx, x, y, fill) {

                ctx.save();

                ctx.translate(x, y);
                ctx.rotate(NOTE_HEAD_ROTATION);
                ctx.scale(1.0 * NOTE_HEAD_RADIUS_MAX / NOTE_HEAD_RADIUS_MIN, 1);

                ctx.beginPath();
                ctx.arc(0, 0, NOTE_HEAD_RADIUS_MIN, 0, 6.28, false);
                if (fill)
                    ctx.fill();
                else
                    ctx.stroke();

                ctx.restore();
            }

            function noteStemOffset() {
                
                var a = NOTE_HEAD_RADIUS_MAX,
                    b = NOTE_HEAD_RADIUS_MIN,
                    theta = -NOTE_HEAD_ROTATION,
                    bCosTheta = b * Math.cos(theta),
                    aSinTheta = a * Math.sin(theta),
                    r = a * b / Math.sqrt(bCosTheta * bCosTheta + aSinTheta * aSinTheta);

                return r;
            }

            function renderNoteStem(canvas, ctx, x, y) {
                ctx.fillRect(x + noteStemOffset() - 0.5 * NOTE_STEM_WIDTH,
                             y - NOTE_STEM_HEIGHT,
                             NOTE_STEM_WIDTH,
                             NOTE_STEM_HEIGHT);
            }

            function renderQuarterNote(canvas, ctx, x, y) {
                renderNoteHead(canvas, ctx, x, y, true);
                renderNoteStem(canvas, ctx, x, y);
            }

            function renderBackground(canvas, ctx) { 
                ctx.fillStyle = 'rgb(255, 255, 255)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }

            function renderStaff(canvas, ctx) {
                var dim = dimensions(canvas),
                    w = dim[0], h = dim[1];

                ctx.fillStyle = 'rgb(0, 0, 0)';

                var y = MARGIN_VERT;
                while (y < canvas.height - MARGIN_VERT) {

                    for (var i = 0; i < STAFF_LINE_COUNT; ++i) {
                        ctx.fillRect(MARGIN_HORIZ,
                                     y,
                                     w - 2 * MARGIN_HORIZ,
                                     STAFF_LINE_HEIGHT);


                        y += STAFF_LINE_SPACING;
                    }

                    y += STAFF_SPACING;
                }
            }

            function enableRetina(canvas, ctx) {
                if (window.devicePixelRatio) {
                    var ratio = window.devicePixelRatio;

                    var w = canvas.width;
                    var h = canvas.height;

                    canvas.width = w * ratio;
                    canvas.height = h * ratio;

                    canvas.style.width = w + 'px';
                    canvas.style.height = h + 'px';

                    ctx.scale(ratio, ratio);
                }
            }

            function debug() {
                var canvas = document.getElementById('testCanvas');
                var ctx = canvas.getContext('2d');
                enableRetina(canvas, ctx);

                renderBackground(canvas, ctx);
                renderStaff(canvas, ctx);
                renderQuarterNote(canvas, ctx, 50, 50);
            }

/*
   Write a few renderNote variants that render some notes
   Write a render measure that renders a single measure (with notes and divider bars)
   Make a renderContext struct that we can use to render all the measures
   Add moar notation!
 */

        </script>

        <style type="text/css">
            
            canvas { 
                border: 1px solid black;
                display: block;
                margin-left: auto;
                margin-right: auto;
            }

        </style>
    </head>

    <body onload="debug()">
        <canvas id="testCanvas" width="800" height="1200"></canvas>
    </body>

</html>

